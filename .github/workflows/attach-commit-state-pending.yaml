name: Mark commit unreviewed

on:
  push:
    branches: [ main ]

permissions:
  statuses: write

concurrency:
  group: mark-commit-as-pending
  cancel-in-progress: false

jobs:
  unreviewed:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.TRUNKTOPUS_APP_ID }}
          private-key: ${{ secrets.TRUNKTOPUS_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
      - uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const commits = context.payload.commits?.map(c => c.id) ?? [context.sha];

            for (const sha of commits) {
              await github.rest.repos.createCommitStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha,
                state: "pending",
                context: "peer-review",
                description: "Awaiting peer review",
              });
            }
